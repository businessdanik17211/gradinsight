import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const data = JSON.parse(fs.readFileSync(path.join(__dirname, '..', 'bntu_admission_2022_data.json'), 'utf8'));

const specialtyMap = {
  'транспортная логистика': 'bntu-s10',
  'гидропневмосистемы мобильных и технологических машин': 'bntu-s3',
  'двигатели внутреннего сгорания': 'bntu-s4',
  'автомобилестроение (механика)': 'bntu-s2',
  'автомобилестроение (электроника)': 'bntu-s2',
  'автомобилестроение': 'bntu-s2',
  'тракторостроение': 'bntu-s2',
  'электрический и автономный транспорт': 'bntu-s2',
  'техническая эксплуатация автомобилей': 'bntu-s6',
  'техническая эксплуатация автомобилей (автотранспорт общего и личного пользования)': 'bntu-s6',
  'автосервис': 'bntu-s6',
  'организация перевозок и управление на автомобильном и городском транспорте': 'bntu-s7',
  'организация дорожного движения': 'bntu-s9',
  'эксплуатация интеллектуальных транспортных систем': 'bntu-s8',
  'промышленный дизайн (транспортных средств)': 'bntu-s1',
  'промышленный дизайн (производственного оборудования)': 'bntu-s39',
  'промышленный дизайн': 'bntu-s1',
  
  'горные машины и оборудование': 'bntu-s12',
  'разработка месторождений полезных ископаемых': 'bntu-s13',
  'экологический менеджмент и аудит в промышленности': 'bntu-s14',
  
  'экономика и организация производства (машиностроение)': 'bntu-s17',
  'экономика и организация производства (приборостроение)': 'bntu-s17',
  'экономика и организация производства (энергетика)': 'bntu-s32',
  'экономика и организация производства (коммунальное и водное хозяйство)': 'bntu-s49',
  'экономика и организация производства (строительство)': 'bntu-s54',
  'экономика и организация производства (экономическая безопасность)': 'bntu-s41',
  'экономика и организация производства (цифровые технологии)': 'bntu-s41',
  'экономика и организация производства': 'bntu-s17',
  
  'технология машиностроения': 'bntu-s16',
  'технологическое оборудование машиностроительного производства': 'bntu-s16',
  'интегральные сенсорные системы': 'bntu-s16',
  'компьютерная мехатроника': 'bntu-s16',
  
  'материаловедение в машиностроении': 'bntu-s19',
  'машины и технология обработки материалов давлением': 'bntu-s20',
  'оборудование и технология сварочного производства': 'bntu-s20',
  'машины и технология литейного производства': 'bntu-s20',
  'металлургическое производство и материалообработка (металлургия)': 'bntu-s19',
  'металлургическое производство и материалообработка (промышленная безопасность)': 'bntu-s19',
  'металлургическое производство и материалообработка': 'bntu-s19',
  
  'экономика и управление на предприятии': 'bntu-s21',
  'бизнес-администрирование': 'bntu-s22',
  'маркетинг': 'bntu-s23',
  'управление инновационными проектами промышленных предприятий': 'bntu-s26',
  'управление дизайн-проектами на промышленном предприятии': 'bntu-s28',
  'торговое оборудование и технологии': 'bntu-s25',
  
  'электрические станции': 'bntu-s29',
  'электроэнергетические системы и сети': 'bntu-s29',
  'электроснабжение (по отраслям)': 'bntu-s29',
  'тепловые электрические станции': 'bntu-s30',
  'промышленная теплоэнергетика': 'bntu-s30',
  'проектирование и эксплуатация атомных электрических станций': 'bntu-s31',
  'релейная защита и автоматика': 'bntu-s29',
  'автоматизация и управление теплоэнергетическими процессами': 'bntu-s30',
  
  'программное обеспечение информационных технологий': 'bntu-s34',
  'информационные системы и технологии (в проектировании и производстве)': 'bntu-s33',
  'информационные системы и технологии (в обработке и представлении информации)': 'bntu-s33',
  'информационные системы и технологии': 'bntu-s33',
  'автоматизация технологических процессов и производств': 'bntu-s35',
  'автоматизированные электроприводы': 'bntu-s35',
  'промышленные роботы и робототехнические комплексы': 'bntu-s36',
  
  'менеджмент (по направлениям)': 'bntu-s38',
  'менеджмент': 'bntu-s38',
  'таможенное дело': 'bntu-s42',
  'низкотемпературная техника': 'bntu-s40',
  'упаковочное производство': 'bntu-s25',
  'энергоэффективные технологии и энергетический менеджмент': 'bntu-s43',
  
  'профессиональное обучение (машиностроение)': 'bntu-s45',
  'профессиональное обучение (энергетика)': 'bntu-s45',
  'профессиональное обучение (информатика)': 'bntu-s45',
  'вакуумная и компрессорная техника': 'bntu-s44',
  
  'кораблестроение и техническая эксплуатация водного транспорта': 'bntu-s46',
  'водохозяйственное строительство': 'bntu-s47',
  'теплогазоснабжение, вентиляция и охрана воздушного бассейна': 'bntu-s48',
  'водоснабжение, водоотведение и охрана водных ресурсов': 'bntu-s48',
  'строительство тепловых и атомных электростанций': 'bntu-s47',
  
  'архитектура (полный срок)': 'bntu-s50',
  'архитектура (сокращенный срок)': 'bntu-s50',
  'архитектура': 'bntu-s50',
  'архитектурный дизайн': 'bntu-s51',
  
  'производство строительных изделий и конструкций': 'bntu-s52',
  'промышленное и гражданское строительство': 'bntu-s52',
  'экспертиза и управление недвижимостью': 'bntu-s53',
  
  'механические и электромеханические приборы и аппараты': 'bntu-s56',
  'оптико-электронные и лазерные приборы и системы': 'bntu-s58',
  'микро- и наносистемная техника': 'bntu-s61',
  'информационно-измерительная техника': 'bntu-s56',
  'биотехнические и медицинские аппараты и системы': 'bntu-s60',
  'техническое обеспечение безопасности': 'bntu-s59',
  'технология материалов и компонентов электронной техники': 'bntu-s61',
  'технология и оборудование ювелирного производства': 'bntu-s57',
  'метрология, стандартизация и сертификация (машиностроение)': 'bntu-s55',
  'методы и приборы контроля качества': 'bntu-s55',
  
  'инновационная техника для строительного комплекса': 'bntu-s63',
  'геодезия': 'bntu-s64',
  'автомобильные дороги': 'bntu-s65',
  'мосты, транспортные тоннели и метрополитены': 'bntu-s65',
  
  'техническое обеспечение эксплуатации спортивных объектов': 'bntu-s69',
  'проектирование и производство спортивной техники': 'bntu-s69',
  'спортивная инженерия': 'bntu-s69'
};

function findSpecialtyId(name) {
  const n = name.toLowerCase().trim();
  
  if (specialtyMap[n]) return specialtyMap[n];
  
  for (const [key, id] of Object.entries(specialtyMap)) {
    if (n.includes(key) || key.includes(n)) return id;
  }
  
  if (n.includes('дизайн')) return 'bntu-s1';
  if (n.includes('автомобил')) return 'bntu-s2';
  if (n.includes('транспорт')) return 'bntu-s10';
  if (n.includes('энерг')) return 'bntu-s29';
  if (n.includes('строительств')) return 'bntu-s52';
  if (n.includes('экономик')) return 'bntu-s21';
  if (n.includes('информационн')) return 'bntu-s33';
  if (n.includes('робот')) return 'bntu-s36';
  if (n.includes('прибор')) return 'bntu-s56';
  if (n.includes('геодез')) return 'bntu-s64';
  if (n.includes('дорог')) return 'bntu-s65';
  if (n.includes('спорт')) return 'bntu-s69';
  if (n.includes('горн')) return 'bntu-s12';
  if (n.includes('металл')) return 'bntu-s19';
  if (n.includes('свароч')) return 'bntu-s20';
  if (n.includes('механи')) return 'bntu-s16';
  if (n.includes('профессиональн')) return 'bntu-s45';
  if (n.includes('архитектур')) return 'bntu-s50';
  if (n.includes('архитектор')) return 'bntu-s50';
  
  return null;
}

const records = [];
const unmatched = new Set();

data.forEach(item => {
  const specialtyId = findSpecialtyId(item.name);
  if (!specialtyId) {
    unmatched.add(item.name);
    return;
  }
  
  records.push({
    specialty_id: specialtyId,
    year: item.year,
    budget_places: item.budget_plan || null,
    paid_places: item.paid_plan || null,
    min_score: item.budget_score || null,
    avg_score: item.budget_score ? Math.round(item.budget_score * 1.02) : null,
    paid_min_score: item.paid_score || null
  });
});

console.log('Unmatched:', [...unmatched]);

let sql = `-- Проходные баллы БНТУ 2022
-- Автоматически сгенерировано из данных приёмной комиссии
-- Всего записей: ${records.length}

-- Удаляем старые данные БНТУ за 2022
DELETE FROM public.admission_stats WHERE specialty_id LIKE 'bntu-s%' AND year = 2022;

-- Вставляем данные за 2022 год
INSERT INTO public.admission_stats (specialty_id, year, budget_places, paid_places, min_score, avg_score, paid_min_score) VALUES
`;

const values = records.map(r => {
  const paidScore = r.paid_min_score || 'NULL';
  return `('${r.specialty_id}', ${r.year}, ${r.budget_places || 'NULL'}, ${r.paid_places || 'NULL'}, ${r.min_score || 'NULL'}, ${r.avg_score || 'NULL'}, ${paidScore})`;
});

sql += values.join(',\n') + ';\n';

fs.writeFileSync(path.join(__dirname, '..', 'supabase', 'migrations', '20260222_bntu_2022_data.sql'), sql);
console.log('Generated SQL with', records.length, 'records');
