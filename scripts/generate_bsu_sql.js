import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Load JSON data
const data = JSON.parse(fs.readFileSync(path.join(__dirname, '..', 'bsu_admission_all_data.json'), 'utf8'));

// Complete specialty mapping - PDF name -> ID
const specialtyMap = {
  // Биологический факультет
  'биология': 'bsu-s39',
  'биохимия': 'bsu-s40',
  'микробиология': 'bsu-s41',
  'биоинженерия и биоинформатика': 'bsu-s42',
  'экология': 'bsu-s43',
  'фундаментальная и прикладная биотехнология': 'bsu-s44',
  'биотехнология': 'bsu-s45',
  
  // Химический факультет
  'химия': 'bsu-s29',
  'химия лекарственных соединений': 'bsu-s30',
  'химия высоких энергий': 'bsu-s31',
  'фундаментальная химия': 'bsu-s32',
  'химия (научно- педагогическая деятельность)': 'bsu-s33',
  'химия (научно-производственная деятельность)': 'bsu-s29',
  'химия (научно-педагогическая деятельность)': 'bsu-s33',
  'химия (фармацевтическая деятельность)': 'bsu-s30',
  
  // Физический факультет
  'компьютерная физика': 'bsu-s34',
  'прикладная физика': 'bsu-s35',
  'фундаментальная физика': 'bsu-s36',
  'ядерные физика и технологии': 'bsu-s37',
  'физика': 'bsu-s38',
  'физика (научно-исследовательская деятельность)': 'bsu-s38',
  'радиофизика': 'bsu-s5',
  'аэрокосмические радиоэлектронные и информационные системы и технологии': 'bsu-s5',
  'ядерные физика и технология': 'bsu-s37',
  'физика наноматериалов и нанотехнологий': 'bsu-s38',
  
  // Факультет прикладной математики и информатики
  'прикладная математика': 'bsu-s1',
  'прикладная информатика': 'bsu-s2',
  'информатика': 'bsu-s3',
  'кибербезопасность': 'bsu-s4',
  'кибербезапасность': 'bsu-s4',
  'прикладная информатика (программное обеспечение компьютерных систем)': 'bsu-s2',
  'прикладная информатика (информационные технологии телекоммуникационных систем)': 'bsu-s2',
  'прикладная информатика (веб- программирование и компьютерный дизайн)': 'bsu-s2',
  'математика и информационные технологии': 'bsu-s2',
  'экономическая кибернетика': 'bsu-s81',
  'экономическая кибернетика (направление - математические методы и компьютерное моделирование в экономике)': 'bsu-s81',
  
  // ФРКТ
  'радиофизика и информационные технологии': 'bsu-s5',
  'интеллектуальная электроника': 'bsu-s5',
  
  // Экономический факультет
  'международная экономика и торговля': 'bsu-s8',
  'государственный аудит': 'bsu-s9',
  'менеджмент': 'bsu-s10',
  'финансы и кредит': 'bsu-s11',
  'экономика': 'bsu-s12',
  'экономическая безопасность': 'bsu-s13',
  'экономическая информатика': 'bsu-s14',
  'мировая экономика': 'bsu-s8',
  
  // Юридический факультет
  'экономическое право': 'bsu-s15',
  'правоведение': 'bsu-s16',
  'правоведение (сокращенный срок обучения)': 'bsu-s16',
  
  // Филологический факультет
  'восточная филология': 'bsu-s18',
  'романо-германская филология': 'bsu-s19',
  'русская филология': 'bsu-s20',
  'славянская филология': 'bsu-s21',
  'белорусская филология': 'bsu-s22',
  'классическая филология': 'bsu-s23',
  'романо-германская (английская) филология': 'bsu-s19',
  'романо-германская (итальянская) филология': 'bsu-s19',
  'романо-германская (немецкая) филология': 'bsu-s19',
  'романо-германская (французская) филология': 'bsu-s19',
  'восточная (китайская) филология': 'bsu-s18',
  'славянская (славянская и белорусская) филология': 'bsu-s21',
  'славянская (славянская и русская) филология': 'bsu-s21',
  
  // Исторический факультет
  'история': 'bsu-s24',
  'музейное дело': 'bsu-s25',
  'регионоведение': 'bsu-s26',
  'архивное дело': 'bsu-s27',
  'управление документами': 'bsu-s28',
  'музейное дело и охрана историко-культурного наследия (по направлениям)': 'bsu-s25',
  'историко-архивоведение': 'bsu-s27',
  'регионовединие': 'bsu-s26',
  
  // ФМО
  'международные отношения': 'bsu-s46',
  'международное право': 'bsu-s47',
  'таможенное дело': 'bsu-s48',
  'экономическая дипломатия': 'bsu-s49',
  'востоковедение': 'bsu-s46',
  'международная конфликтология': 'bsu-s46',
  'международная логистика': 'bsu-s48',
  
  // ФСК
  'современные иностранные языки': 'bsu-s50',
  'переводческое дело': 'bsu-s51',
  'дизайн предметно-пространственной среды': 'bsu-s53',
  'социально-культурный менеджмент и коммуникации': 'bsu-s54',
  'дизайн костюма и текстиля': 'bsu-s55',
  'графический дизайн и мультимедиадизайн': 'bsu-s56',
  'дизайн (направление - дизайн предметно- пространственной среды)': 'bsu-s53',
  'дизайн (направление - коммуникативный)': 'bsu-s56',
  'дизайн (костюма и тканей)': 'bsu-s55',
  'дизайн предметно- пространственной среды': 'bsu-s53',
  'дизайн костюма и текстиля': 'bsu-s55',
  'графический дизайн и мультимедиадизайн (сокращенный срок обучения)': 'bsu-s56',
  'культурология (прикладная)': 'bsu-s54',
  'компьютерное моделирование и разработка веб-приложений': 'bsu-s52',
  
  // Журналистика
  'журналистика': 'bsu-s58',
  'информация и коммуникация': 'bsu-s59',
  
  // География и геоинформатика
  'география': 'bsu-s62',
  'геотехнологии туризма и экскурсионная деятельность': 'bsu-s63',
  'гидрометеорология': 'bsu-s64',
  'космоаэрокартография и геодезия': 'bsu-s65',
  'геоэкология': 'bsu-s66',
  'геология': 'bsu-s67',
  'геоинформационные системы': 'bsu-s68',
  'космоаэрокартография': 'bsu-s65',
  'страноведение и переводческая деятельность': 'bsu-s69',
  
  // Философия и социальных наук
  'философия': 'bsu-s70',
  'социология': 'bsu-s71',
  'психология': 'bsu-s72',
  'социальные коммуникации': 'bsu-s73',
  'cоциальные коммуникации': 'bsu-s73',
  'лингвострановедение': 'bsu-s71',
  'политология (направление - политико-юридическая деятельность)': 'bsu-s73',
  
  // Военный факультет
  'геоинформационные системы (специальные)': 'bsu-s74',
  'правоведение (военная)': 'bsu-s75',
  'геоинформационные системы (специальные) (ж)': 'bsu-s74',
  'геоинформационные системы (специальные) (м)': 'bsu-s74',
  'правоведение (юрисконсультская работа в военной сфере)(м)': 'bsu-s75',
  'правоведение (юрисконсультская работа в военной сфере)(ж)': 'bsu-s75',
  'международные отношения (военная сфера)(м)': 'bsu-s77',
  'международные отношения (информационная сфера)(м)': 'bsu-s78',
  'международные отношения (информационная сфера)(ж)': 'bsu-s78',
  'радиационная, химическая и биологическая защита': 'bsu-s76',
  
  // Механико-математический
  'математика': 'bsu-s79',
  'механика и математическое моделирование': 'bsu-s80',
  'математика и компьютерные науки': 'bsu-s81',
  'компьютерная математика и системный анализ': 'bsu-s82',
  'математика (научно-производственная деятельность)': 'bsu-s79',
  'математика (научно-педагогическая деятельность)': 'bsu-s79',
  
  // Институт бизнеса
  'бизнес-администрирование': 'bsu-s83',
  'логистика': 'bsu-s84',
  'управление информационными ресурсами': 'bsu-s85',
  'маркетинг': 'bsu-s86',
  'документоведение (по направлениям)': 'bsu-s85',
  
  // Институт теологии
  'теология': 'bsu-s87',
  
  // МГЭИ
  'медико-биологическое дело': 'bsu-s88',
  'экология': 'bsu-s43',  // Биологический факультет (по умолчанию)
  'биоэкология': 'bsu-s43',
  'медицинская экология': 'bsu-s43',
  'медицинская физика': 'bsu-s90',
  'информационные системы и технологии': 'bsu-s91',
  'природоохранная деятельность': 'bsu-s92',
  'ядерная и радиационная безопасность': 'bsu-s93',
  'теплоэнергетика и теплотехника': 'bsu-s94',
  'теплоэнергеника и теплотехника': 'bsu-s94',
  
  // МГЭИ - Экология (отдельный ID для института)
  'экология (мгэи)': 'bsu-s89',
  
  // Дополнительные
  'социальная работа (по направлениям)': 'bsu-s73',
  'прикладная криптография': 'bsu-s4',
  'компьютерная безопасность (направление - математические методы и программные системы)': 'bsu-s4',
  'компьютерная безопасность (направление - радиофизические методы и программно-технические средства)': 'bsu-s4',
  'геология и разведка месторождений полезных ископаемых': 'bsu-s67',
  'геоинформационные системы (направление - земельно- кадастровые)': 'bsu-s68',
  'геоинформационные системы (направление - специальные)': 'bsu-s74',
  'энергоэффективные технологии и энергетический менеджмент': 'bsu-s94',
  'информационные системы и технологии (в экологии)': 'bsu-s91',
  'информационные системы и технологии (в здравоохранении)': 'bsu-s91',
  'экономическая безопасность': 'bsu-s13',
  'ядерная и радиационная безопасность': 'bsu-s93',
  'культурология (прикладная)': 'bsu-s54',
  'лингвострановедение': 'bsu-s50',
  'музейное дело и охрана историко-культурного наследия (по направлениям)': 'bsu-s25',
  'музейное дело и охрана историко-культурного наследия': 'bsu-s25',
  'историко-архивоведение': 'bsu-s27',
  'документоведение (по направлениям)': 'bsu-s28',
  'космоаэрокартография': 'bsu-s65',
  'экономическая кибернетика (направление - математические методы и компьютерное моделирование в экономике)': 'bsu-s14',
  'политология (направление - политико-юридическая деятельность)': 'bsu-s73',
  'регионовединие': 'bsu-s26',
  'теплоэнергеника и теплотехника': 'bsu-s94',
  'cоциальные коммуникации': 'bsu-s73',
  'славянская (славянская и белорусская) филология': 'bsu-s21',
  'славянская (славянская и русская) филология': 'bsu-s21',
  'государственный аудит': 'bsu-s9',
  'радиационная, химическая и биологическая защита': 'bsu-s75',
  'востоковедение': 'bsu-s46',
  'бизнес- администрирование': 'bsu-s83',
  'страноведение и переводческая деятельность': 'bsu-s51',
  'страноведение и пкереводческая деятельность': 'bsu-s51',
  'международная конфликтология': 'bsu-s46',
  'интеллектуальная электроника': 'bsu-s5',
  'компьютерное моделирование и разработка веб-приложений': 'bsu-s52',
  'классическая филология': 'bsu-s23',
  
  // Совместный институт БГУ и ДПУ
  'прикладная физика (совместный институт бгу- дпу)': 'bsu-s95',
  'прикладная физика (совместный институт бгу-дпу)': 'bsu-s95',
  'механика и математическое моделирование (совместный институт бгу и дпу)': 'bsu-s97',
  'механика и математическое моделирование - образовательная программа бгу и дпу': 'bsu-s97',
  'мировая экономика - образовательная программа бгу и дпу': 'bsu-s96',
  'мировая экономика (совместный институт бгу и дпу)': 'bsu-s96',
  'мировая экономика (совместный институт бгу- дпу)': 'bsu-s96',
  'физика (направление - производственная деятельность) - образовательная программа бгу и дпу': 'bsu-s95',
  
  // Дополнительные записи с полными названиями
  'информационные системы и технологии (в экологии)': 'bsu-s91',
  'информационные системы и технологии (в здравоохранении)': 'bsu-s91',
  'международная логистика': 'bsu-s84',  // Институт бизнеса, не ФМО
};

function findSpecialtyId(name, faculty) {
  const n = name.toLowerCase().trim().replace(/\s+/g, ' ');
  
  // Special case for экология - depends on faculty
  if (n === 'экология') {
    if (faculty && faculty.toLowerCase().includes('сахаров')) {
      return 'bsu-s89'; // МГЭИ
    }
    return 'bsu-s43'; // Биологический факультет по умолчанию
  }
  
  // Special case for мировая экономика - depends on context
  if (n.includes('мировая экономика')) {
    if (n.includes('дпу') || n.includes('даляньск') || n.includes('совместный институт')) {
      return 'bsu-s96'; // Совместный институт БГУ и ДПУ
    }
    return 'bsu-s8'; // Экономический факультет
  }
  
  if (specialtyMap[n]) return specialtyMap[n];
  if (specialtyMap[name.toLowerCase().trim()]) return specialtyMap[name.toLowerCase().trim()];
  
  for (const [key, id] of Object.entries(specialtyMap)) {
    if (n.includes(key) || key.includes(n)) return id;
  }
  
  // Partial matches
  if (n.includes('английск')) return 'bsu-s19';
  if (n.includes('немецк')) return 'bsu-s19';
  if (n.includes('французск')) return 'bsu-s19';
  if (n.includes('итальянск')) return 'bsu-s19';
  if (n.includes('китайск')) return 'bsu-s18';
  if (n.includes('военн')) return 'bsu-s75';
  if (n.includes('дпу') || n.includes('даляньск')) return 'bsu-s95';
  if (n.includes('дизайн')) return 'bsu-s53';
  if (n.includes('биология')) return 'bsu-s39';
  if (n.includes('гео')) return 'bsu-s62';
  
  return null;
}

const records = new Map();
const unmatched = new Set();

data.forEach(item => {
  const specialtyId = findSpecialtyId(item.name, item.faculty);
  if (!specialtyId) {
    if (item.score_budget > 0 || item.score_paid > 0) {
      unmatched.add(item.name);
    }
    return;
  }
  
  const key = `${specialtyId}-${item.year}`;
  const scoreBudget = parseInt(item.score_budget) || 0;
  const scorePaid = parseInt(item.score_paid) || 0;
  const places = parseInt(item.places_budget) || 0;
  const avgBudget = parseInt(item.avg_budget) || 0;
  
  const existing = records.get(key);
  
  // For type "both" (2024, 2025), we have both scores in one record
  if (item.type === 'both') {
    if (existing) {
      if (scoreBudget > 0 && !existing.min_score) existing.min_score = scoreBudget;
      if (scorePaid > 0) existing.paid_score = scorePaid;
    } else {
      records.set(key, {
        specialty_id: specialtyId,
        year: item.year,
        budget_places: places || null,
        paid_places: null,
        min_score: scoreBudget,
        avg_score: avgBudget > 0 ? avgBudget : Math.round(scoreBudget * 1.02),
        paid_score: scorePaid > 0 ? scorePaid : null
      });
    }
  } 
  // For type "budget" (2022, 2023) - handle duplicates
  else if (item.type === 'budget') {
    if (existing) {
      // If we have an existing record with higher score, this might be paid
      if (existing.min_score && scoreBudget > 0 && scoreBudget < existing.min_score) {
        // Lower score = likely paid
        existing.paid_score = scoreBudget;
      } else if (scoreBudget > existing.min_score) {
        // Higher score = budget, old score = paid
        existing.paid_score = existing.min_score;
        existing.min_score = scoreBudget;
        existing.avg_score = avgBudget > 0 ? avgBudget : Math.round(scoreBudget * 1.02);
      }
      if (places > 0) existing.budget_places = places;
    } else {
      records.set(key, {
        specialty_id: specialtyId,
        year: item.year,
        budget_places: places || null,
        paid_places: null,
        min_score: scoreBudget,
        avg_score: avgBudget > 0 ? avgBudget : Math.round(scoreBudget * 1.02),
        paid_score: null
      });
    }
  }
  // For type "paid" (2023 paid)
  else if (item.type === 'paid') {
    if (existing) {
      if (scoreBudget > 0) existing.paid_score = scoreBudget;
    } else {
      records.set(key, {
        specialty_id: specialtyId,
        year: item.year,
        budget_places: null,
        paid_places: null,
        min_score: null,
        avg_score: null,
        paid_score: scoreBudget
      });
    }
  }
});

console.log('Unmatched:', [...unmatched].length);

// Generate SQL
let sql = `-- Полные проходные баллы БГУ 2022-2025
-- Автоматически сгенерировано из PDF файлов
-- Всего записей: ${records.size}

-- Удаляем старые данные БГУ
DELETE FROM public.admission_stats WHERE specialty_id LIKE 'bsu-s%';

-- Вставляем полные данные (включая баллы на платное обучение)
INSERT INTO public.admission_stats (specialty_id, year, budget_places, paid_places, min_score, avg_score, paid_min_score) VALUES
`;

const values = [];
records.forEach((r) => {
  if (r.min_score > 0 || r.paid_score > 0) {
    const paidScore = r.paid_score ? r.paid_score : 'NULL';
    values.push(`('${r.specialty_id}', ${r.year}, ${r.budget_places || 'NULL'}, ${r.paid_places || 'NULL'}, ${r.min_score || 'NULL'}, ${r.avg_score || 'NULL'}, ${paidScore})`);
  }
});

sql += values.join(',\n') + ';\n';

fs.writeFileSync(path.join(__dirname, '..', 'supabase', 'migrations', '20260221_bsu_complete_data.sql'), sql);
console.log('Generated SQL with', values.length, 'records');
